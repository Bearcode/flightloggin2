<!DOCTYPE html>
<html>
    <head>
        <title>New Flight</title>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1"> 
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css" />
        <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>

        <script type="text/javascript" src="{% static 'js/jquery.jclock.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/suncalc.min.js' %}"></script>
        <script type="text/javascript" src="{% static 'js/mobilelogger.js' %}"></script>
        
        <style>
            div {text-align: center}
            div.time_container {font-size: x-large}

            div#total_time { color: black}
            div#day_landings {color: black}
            div#night_landings {font-size: x-large}
            div#approaches {font-size: x-large; color: black}
            div#hood_time {font-size: x-large; color: black}
            div#actual_time {font-size: x-large; color: black}

            div#page_two {border: 1px solid black; width: 300px}
            div#page_one {border: 1px solid black; width: 300px}
            div#page_three {border: 1px solid black; width: 300px}

            div#clock {width: 100%; text-align: center}

            table {width: 100%}
            table.current_times td {border: 1px solid black }

            form input[type=number] {width: 4em}
        </style>
    </head>
    <body>
        <div data-role="page" id="one" data-theme="c">
            <div data-role="header">
                <h1>New Flight</h1>
            </div>
            <div data-role="content">
                <label for="person">Person:</label><input type="text" id="person" name="person">
                <br>    
                <label for="plane">Plane:</label><input type="text" id="plane" name="plane">
                <br>
                <label for="purpose">Purpose:</label>
                <select id="purpose">
                    <option value="captain">Captain</option>
                    <option value="fo">First Officer</option>
                    <option value="instructor">Instructor</option>
                    <option value="student">Student</option>
                    <option value="training">Training</option>
                    <option value="solo">Solo</option>
                </select>
                <a href="#two" data-role="button" id="start_button" data-theme="e">Start</button>
            </div>
            <div data-role="footer">
                <h4><a href="/logbook">Back to logbook</a></h4>
            </div>
        </div>

        <div data-role="page" id="two" data-theme="c">
            <div data-role="header">
                <h1 id="outer_clock"><span id="clock"></span> Z</h1>
            </div>
            <div data-role="content">
                <table class="current_times">
                    <tr>
                        <th>Total</th> <th>Night</th> <th>Hood</th> <th>Actual</th>
                    </tr>
                    <tr>
                        <td><div class="time_container" id="total_time">0.0</div></td>
                        <td><div class="time_container" id="night_time">0.0</div></td>
                        <td><div class="time_container" id="hood_time">0.0</div></td>
                        <td><div class="time_container" id="actual_time">0.0</div></td>
                    </tr>
                </table>
                <table class="current_times">
                    <tr>
                        <th>Day Landings</th> <th>Night Landings</th> <th>Approaches</th>
                    </tr>
                    <tr>
                        <td><div class="time_container" id="day_landings">0</div></td>
                        <td><div class="time_container" id="night_landings">0</div></td>
                        <td><div class="time_container" id="approaches">0</div></td>
                    </tr>
                </table>

                <div data-role="controlgroup" data-type="horizontal">
                    <button id="landing_button" data-icon="add">Land</button>
                    <button id="waypoint_button" data-icon="add">WP</button>
                    <button id="approach_button" data-icon="add">App</button>
                </div>
                <fieldset data-role="controlgroup" data-type="horizontal" id="inst_condition">
                    <input type="radio" name="inst_condition" id="radio-choice-21" value="visual" checked="checked">
                    <label for="radio-choice-21">Visual</label>

                    <input type="radio" name="inst_condition" id="radio-choice-22" value="hood">
                    <label for="radio-choice-22">Hood</label>

                    <input type="radio" name="inst_condition" id="radio-choice-23" value="actual">
                    <label for="radio-choice-23">Actual</label>
                </fieldset>
                <a href="#three" data-role="button"  data-theme="e" id="shutdown_button">Shutdown</a>
                <div id="day_night"></div>
                <div id="next">
                    <table>
                        <tr>
                            <td>Next Morning Twilight:</td>
                            <td><span id="morning_twilight"></span> Z</td>
                        </tr>
                        <tr>
                            <td>Next Sunrise:</td>
                            <td><span id="sunrise"></span> Z</td>
                        </tr>
                        <tr>
                            <td>Next Sunset:</td>
                            <td><span id="sunset"></span> Z</td>
                        </tr>
                        <tr>
                            <td>Next Evening Twilight:</td>
                            <td><span id="evening_twilight"></span> Z</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div data-role="footer">
                <h4><a href="/logbook">Back to logbook</a></h4>
            </div>
        </div>

        <div data-role="page" id="three" data-theme="c">
            <div data-role="header">
                <h1>Submit Flight</h1>
            </div>
            <div data-role="content">
                <form>
                    <table>
                        <tr>
                            <td>
                                <label for="total">Total</label>
                                <input type="number" name="total"><br>
                                <label for="pic">PIC</label>
                                <input type="number" name="pic"><br>
                                <label for="sic">SIC</label>
                                <input type="number" name="sic"><button id="sic">X</button><br>
                                <label for="solo">Solo</label>
                                <input type="number" name="solo"><br>
                                <label for="dual_r">Dual Recieved</label>
                                <input type="number" name="dual_r"><br>
                                <label for="xc">Cross Country</label>
                                <input type="number" name="xc"><br>
                            </td>
                            <td>
                                <label for="dual_g">Dual Given</label>
                                <input type="number" name=""><br>
                                <label for="act_inst">Actual</label>
                                <input type="number" name="actual_inst"><br>
                                <label for="sim_inst">Hood</label>
                                <input type="number" name="sim_inst"><br>
                                <label for="day_l">Day Landings</label>
                                <input type="number" name="day_l"><br>
                                <label for="night_l">Night Landings</label>
                                <input type="number" name="night_l"><br>
                                <label for="approaches">Approaches</label>
                                <input type="number" name="approaches"><br>
                            </td>
                        </tr>
                    </table>
                </form>
            </div>
            <div id="route_box"></div>
            <div data-role="footer">
                <h4><a href="/logbook">Back to logbook</a></h4>
            </div>
        </div>

        <script>
        $("#clock").jclock({utc: true});

        var mct, ect, sunrise, sunset;
        get_location(function(res) {
            var times = SunCalc.getTimes(new Date(),res.coords.latitude, res.coords.longitude);
            mct = [times.dawn.getUTCHours(), times.dawn.getUTCMinutes()];
            ect = [times.dusk.getUTCHours(), times.dusk.getUTCMinutes()];
            sunrise = [times.sunrise.getUTCHours(), times.sunrise.getUTCMinutes(), 0];
            sunset = [times.sunset.getUTCHours(), times.sunset.getUTCMinutes(), 0];
            $('#next #morning_twilight').text(mct[0] + ":" + mct[1]);
            $('#next #sunset').text(sunset[0] + ":" + sunset[1]);
            $('#next #evening_twilight').text(ect[0] + ":" + ect[1]);
            $('#next #sunrise').text(sunrise[0] + ":" + sunrise[1]);
        });

        var start_time, night_start, night_stop;
        $("#start_button").click(function() {
            start_time = get_current_time();
            if(is_it_day_or_night('flight') == 'night') {
                night_start = start_time
            }

            setInterval(function() {
                var now = get_current_time();
                var elapsed = get_difference(start_time, now);
                $("#total_time").text(tuple_to_display(elapsed));
            }, 30000);

            setInterval(function() {
                var now = get_current_time();
                var currently = is_it_day_or_night('flight');
                if(night_start && currently == 'day') {
                    // just switched from night to day
                    night_stop = now
                } else if(!night_start && currently == 'night') {
                    // just switched from day to night
                    night_start = now
                }

                var duration, decimal;
                if(night_start && !night_stop) {
                    // day timer is still going
                    duration = get_difference(night_start, now);
                    decimal = tuple_to_display(duration);
                }
                if(!night_start) {
                    // day timer has not been started yet.
                    decimal = '0.0';
                }
                if(night_start && night_stop) {
                    // night timer is done. Complete.
                    duration = get_difference(night_start, night_stop);
                    decimal = tuple_to_display(duration);
                }
                $('#night_time').text(decimal);
            }, 5000);
        });

        function close_out_hood(now) {
            if(hood_start) {
                var new_hood = get_difference(hood_start, now);
                hood_acc = add_times(new_hood, hood_acc);
                hood_start = undefined;
            }
        }

        function close_out_actual(now) {
            if(actual_start) {
                var new_actual = get_difference(actual_start, now);
                actual_acc = add_times(new_actual, actual_acc);
                actual_start = undefined;
            }
        }

        var hood_start, actual_start;
        var hood_acc = [0, 0, 0], actual_acc = [0, 0, 0];
        $('input[name=inst_condition]:radio').click(function() {
            var cond = $('input[name=inst_condition]:radio:checked').attr('value');
            var now = get_current_time();
            if(cond == 'visual') {
                close_out_actual(now);
                close_out_hood(now)
            }
            if(cond == 'actual') {
                if(!actual_start) {
                    actual_start = now;
                }
                close_out_hood(now);
            }
            if(cond == 'hood') {
                if(!hood_start) {
                    hood_start = now;
                }
                close_out_actual(now);
            }
        });

        setInterval(function() {
            // every 5 seconds, update the timer display for actual and hood
            var now = get_current_time();
            var new_actual = [0, 0, 0];
            if(actual_start) {
                new_actual = get_difference(actual_start, now);
            }
            var actual = add_times(actual_acc, new_actual);
            decimal = tuple_to_display(actual);
            $('#actual_time').text(decimal);
            
            ///////

            var new_hood = [0, 0, 0];
            if(hood_start) {
                new_hood = get_difference(hood_start, now);
            }
            var hood = add_times(hood_acc, new_hood);
            decimal = tuple_to_display(hood);
            $('#hood_time').text(decimal);

        }, 5000);

        var route_points = [];
        $('#landing_button').click(function() {
            var div = "#" + is_it_day_or_night('landing') + "_landings";
            // increment the correct landing box by one landing.
            var prev = Number($(div).text());
            $(div).text(prev + 1);
            get_location(function(res) {
                route_points.push(['land', res.coords])
            });
        });

        $('#waypoint_button').click(function() {
            get_location(function(res) {
                route_points.push(['waypoint', res.coords]);
            });
        });

        $('#approach_button').click(function() {
            // increment the approach box by one.
            var prev = Number($('#approaches').text());
            $('#approaches').text(prev + 1);
        });

        $('#shutdown_button').click(function() {
            var mode = $('#purpose').val()
            var total = $('#total_time').text();
            var night = $('#night_time').text();
            var hood = $('#hood_time').text();
            var actual = $('#actual_time').text();
            var day_l = $('#day_landings').text();
            var night_l = $('#night_landings').text();
            var approaches = $('#approaches').text();

            $('form input[name=total]').val(total);
            $('form input[name=night]').val(night);
            $('form input[name=act_inst]').val(actual);
            $('form input[name=sim_inst]').val(hood);
            $('form input[name=approaches]').val(approaches);
            $('form input[name=night_l]').val(night_l);
            $('form input[name=day_l]').val(day_l);

            if(mode == 'student') {
                $('form input[name=dual_r]').val(total);
            }
            if(mode == 'fo') {
                $('form input[name=sic]').val(total);
            }
            if(mode == 'captain') {
                $('form input[name=pic]').val(total);
            }
            if(mode == 'instructor') {
                $('form input[name=dual_g]').val(total);
                $('form input[name=pic]').val(total);
            }
            if(mode == 'solo') {
                $('form input[name=solo]').val(total);
                $('form input[name=pic]').val(total);
            }
            if(mode == 'training') {
                $('form input[name=dual_r]').val(total);
                $('form input[name=pic]').val(total);
            }
            make_route_selection(landing_points);
        });

        </script>
    </body>
</html>