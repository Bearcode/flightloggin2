<!DOCTYPE html>{% load analytics %}
<html>
    <head>
        <title>New Flight</title>
        <meta charset="utf-8" name="viewport" content="width=device-width, initial-scale=1"> 
        <link rel="stylesheet" href="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.css">
        <link rel="stylesheet" href="{% static 'mobile_app.css' %}">
        <link rel="stylesheet" href="http://jquerymobile.com/demos/1.2.0/docs/_assets/css/jqm-docs.css">
        <script src="http://code.jquery.com/jquery-1.8.2.min.js"></script>
        <script src="http://code.jquery.com/mobile/1.2.0/jquery.mobile-1.2.0.min.js"></script>

        <script src="{% static 'js/jquery.jclock.js' %}"></script>
        <script src="{% static 'js/suncalc.min.js' %}"></script>
        <script src="{% static 'js/mobilelogger.js' %}"></script>
        <script>
            var username = window.location.href.split('/')[4];
            window.google_analytics_uacct = "UA-501381-5";
            $.mobile.ignoreContentEnabled = true;
        </script>
    </head>
    <body>
        <div data-role="page" id="one" data-theme="c">
            <div data-role="header">
                <h1>New Flight</h1>
            </div>
            <div data-role="content">
                <label for="person">Person:</label>
                <input type="text" id="person" name="person">

                <label for="plane">Plane:</label>
                <select placeholder="plane" id="plane" name="new-plane"></select>

                <div id="currency_display">
                    Day Currency: <span class="day"></span><br>
                    Night Currency: <span class="night"></span><br>
                    Instrument Currency: <span class="instrument"></span>
                </div>

                <label for="purpose">Purpose:</label>
                <select id="purpose">
                    <option value="captain">Captain</option>
                    <option value="fo">First Officer</option>
                    <option value="instructor">Instructor</option>
                    <option value="student">Student</option>
                    <option value="training">Training</option>
                    <option value="solo">Solo</option>
                </select>
                <a href="#two" data-role="button" id="start_button" data-theme="e">Start</a>
            </div>
            <div data-role="footer">
                <h4><a href="/logbook">Back to logbook</a></h4>
            </div>
        </div>

        <div data-role="page" id="two" data-theme="c">
            <div data-role="header">
                <h1 id="outer_clock"><span id="clock"></span> Z</h1>
            </div>
            <div data-role="content">
                <table class="current_times">
                    <tr>
                        <th>Total</th> <th>Night</th> <th>Hood</th> <th>Actual</th>
                    </tr>
                    <tr>
                        <td><div class="time_container" id="total_time">0.0</div></td>
                        <td><div class="time_container" id="night_time">0.0</div></td>
                        <td><div class="time_container" id="hood_time">0.0</div></td>
                        <td><div class="time_container" id="actual_time">0.0</div></td>
                    </tr>
                </table>
                <table class="current_times">
                    <tr>
                        <th>Day Landings</th> <th>Night Landings</th> <th>Approaches</th>
                    </tr>
                    <tr>
                        <td><div class="time_container" id="day_landings">0</div></td>
                        <td><div class="time_container" id="night_landings">0</div></td>
                        <td><div class="time_container" id="approaches">0</div></td>
                    </tr>
                </table>

                <div data-role="controlgroup" data-type="horizontal">
                    <button id="landing_button" data-icon="add">Land</button>
                    <button id="waypoint_button" data-icon="add">WP</button>
                    <button id="approach_button" data-icon="add">App</button>
                </div>
                <fieldset data-role="controlgroup" data-type="horizontal" id="inst_condition">
                    <input type="radio" name="inst_condition" id="radio-choice-21" value="visual" checked="checked">
                    <label for="radio-choice-21">Visual</label>

                    <input type="radio" name="inst_condition" id="radio-choice-22" value="hood">
                    <label for="radio-choice-22">Hood</label>

                    <input type="radio" name="inst_condition" id="radio-choice-23" value="actual">
                    <label for="radio-choice-23">Actual</label>
                </fieldset>
                <a href="#three" data-role="button" data-theme="e" id="shutdown_button">Shutdown</a>
                <div id="day_night"></div>
                <div id="next">
                    <table>
                        <tr>
                            <td>Next Morning Twilight:</td>
                            <td><span id="morning_twilight"></span> Z</td>
                        </tr>
                        <tr>
                            <td>Next Sunrise:</td>
                            <td><span id="sunrise"></span> Z</td>
                        </tr>
                        <tr>
                            <td>Next Sunset:</td>
                            <td><span id="sunset"></span> Z</td>
                        </tr>
                        <tr>
                            <td>Next Evening Twilight:</td>
                            <td><span id="evening_twilight"></span> Z</td>
                        </tr>
                    </table>
                </div>
            </div>
            <div data-role="footer">
                <h4><a href="/logbook">Back to logbook</a></h4>
            </div>
        </div>

        <div data-role="page" id="three" data-theme="c">
            <div data-role="header">
                <h1>Submit Flight</h1>
            </div>
            <div data-role="content">
                <controlgroup data-enhance="false">
                    <table id="results_table">
                        <tr>
                            <td>
                                <div><button>Total</button><input type="number" name="total"></div>
                                <div><button>PIC</button><input type="number" name="pic"></div>
                                <div><button>Dual R.</button><input type="number" name="dual_r"></div>
                                <div><button>Hood</button><input type="number" name="sim_inst"></div>
                                <div><button>XC</button><input type="number" name="xc"></div>
                                <div><button>Day L.</button><input type="number" name="day_l"></div>
                                <div><button>Fuel</button><input type="text" name="fuel_burn"></div>
                            </td>
                            <td>
                                <div><button>Night</button><input type="number" name="night"></div>
                                <div><button>SIC</button><input type="number" name="sic"></div>
                                <div><button>Dual G.</button><input type="number" name="dual_g"></div>
                                <div><button>Actual</button><input type="number" name="act_inst"></div>
                                <div><button>Solo</button><input type="number" name="solo"></div>
                                <div><button>Night L.</button><input type="number" name="night_l"></div>
                                <div><button>App.</button><input type="number" name="app"></div>
                            </td>
                        </tr>
                    </table>
                </controlgroup>
                <textarea name="remarks" placeholder="remarks"></textarea>
                <input type="text" name="route_string" id="route_box">
                <button data-theme="e" id="submit_button">Submit</button>
            </div>
            <div data-role="popup" id="failed_popup" data-overlay-theme="a" data-theme="c" style="max-width:400px;" class="ui-corner-all">
                <div data-role="header" data-theme="a" class="ui-corner-top">
                    <h1>Send Failed</h1>
                </div>
                <div data-role="content" data-theme="d" class="ui-corner-bottom ui-content">
                    <h3 class="ui-title">Connection to server could not be established.</h3>
                    <p>Try again now, or later when you have better connectivity?</p>
                    <a href="#" data-role="button" data-inline="true" data-rel="back" data-theme="c">Now</a>    
                    <a href="#" data-role="button" data-inline="true" data-rel="back" data-transition="flow" data-theme="b">Later</a>  
                </div>
            </div>
            <div data-role="footer">
                <h4><a href="/logbook">Back to logbook</a></h4>
            </div>
        </div>
        {% googleanalyticsjs %}

        <script>
        get_planes(); // fill in the plane select box
        $("#clock").jclock({utc: true});

        $('#results_table button').click(function() {
            // handle auto buttons on page 3
            var total = $('input[name=total]').val();
            var inp = $(this).parent().find('input');
            if(inp.val() == total) {
                inp.val('');
            } else if(inp.val() == '') {
                inp.val(total);
            }
        });

        var mct, ect, sunrise, sunset;
        get_location(function(res) {
            var times = SunCalc.getTimes(new Date(),res.coords.latitude, res.coords.longitude);
            mct = [times.dawn.getUTCHours(), times.dawn.getUTCMinutes()];
            ect = [times.dusk.getUTCHours(), times.dusk.getUTCMinutes()];
            sunrise = [times.sunrise.getUTCHours(), times.sunrise.getUTCMinutes(), 0];
            sunset = [times.sunset.getUTCHours(), times.sunset.getUTCMinutes(), 0];
            $('#next #morning_twilight').text(mct[0] + ":" + mct[1]);
            $('#next #sunset').text(sunset[0] + ":" + sunset[1]);
            $('#next #evening_twilight').text(ect[0] + ":" + ect[1]);
            $('#next #sunrise').text(sunrise[0] + ":" + sunrise[1]);
        });

        var actual_start;
        var actual_acc = [0, 0, 0];
        function update_actual_decimal(now) {
            var new_actual = [0, 0, 0];
            if(actual_start) {
                new_actual = get_difference(actual_start, now);
            }
            var actual = add_times(actual_acc, new_actual);
            decimal = tuple_to_display(actual);
            $('#actual_time').text(decimal);
        }

        var hood_start;
        var hood_acc = [0, 0, 0];
        function update_hood_decimal(now) {
            var new_hood = [0, 0, 0];
            if(hood_start) {
                new_hood = get_difference(hood_start, now);
            }
            var hood = add_times(hood_acc, new_hood);
            decimal = tuple_to_display(hood);
            $('#hood_time').text(decimal);
        }

        var start_time;
        function update_total_decimal(now) {
            var elapsed = get_difference(start_time, now);
            $("#total_time").text(tuple_to_display(elapsed));
        }

        var night_start, night_stop;
        function update_night_decimal(now) {
            var currently = is_it_day_or_night('flight');
            if(night_start && currently == 'day') {
                // just switched from night to day
                night_stop = now;
            } else if(!night_start && currently == 'night') {
                // just switched from day to night
                night_start = now;
            }

            var duration, decimal;
            if(night_start && !night_stop) {
                // day timer is still going
                duration = get_difference(night_start, now);
                decimal = tuple_to_display(duration);
            }
            if(!night_start) {
                // day timer has not been started yet.
                decimal = '0.0';
            }
            if(night_start && night_stop) {
                // night timer is done. Complete.
                duration = get_difference(night_start, night_stop);
                decimal = tuple_to_display(duration);
            }
            $('#night_time').text(decimal);
        }

        var updater_id;
        $("#start_button").click(function() {
            start_time = get_current_time();
            if(is_it_day_or_night('flight') == 'night') {
                night_start = start_time;
            }

            get_location(function(res) {
                route_points.push(['land', res.coords]);
            });

            updater_id = setInterval(function() {
                var now = get_current_time();
                update_night_decimal(now);
                update_total_decimal(now);
                update_hood_decimal(now);
                update_actual_decimal(now);
            }, 5000);
        });

        function close_out_hood(now) {
            if(hood_start) {
                var new_hood = get_difference(hood_start, now);
                hood_acc = add_times(new_hood, hood_acc);
                hood_start = undefined;
            }
        }

        function close_out_actual(now) {
            if(actual_start) {
                var new_actual = get_difference(actual_start, now);
                actual_acc = add_times(new_actual, actual_acc);
                actual_start = undefined;
            }
        }

        $('input[name=inst_condition]:radio').click(function() {
            var cond = $('input[name=inst_condition]:radio:checked').attr('value');
            var now = get_current_time();
            if(cond == 'visual') {
                close_out_actual(now);
                close_out_hood(now)
            }
            if(cond == 'actual') {
                if(!actual_start) {
                    actual_start = now;
                }
                close_out_hood(now);
            }
            if(cond == 'hood') {
                if(!hood_start) {
                    hood_start = now;
                }
                close_out_actual(now);
            }
        });

        var route_points = [];
        $('#landing_button').click(function() {
            var div = "#" + is_it_day_or_night('land') + "_landings";
            // increment the correct landing box by one landing.
            var prev = Number($(div).text());
            $(div).text(prev + 1);
            get_location(function(res) {
                route_points.push(['land', res.coords])
            });
        });

        $('#waypoint_button').click(function() {
            get_location(function(res) {
                route_points.push(['waypoint', res.coords]);
            });
        });

        $('#approach_button').click(function() {
            // increment the approach box by one.
            var prev = Number($('#approaches').text());
            $('#approaches').text(prev + 1);
        });

        $('#shutdown_button').click(function() {
            get_location(function(res) {
                route_points.push(['land', res.coords]);
                make_route_selection(route_points);
            });

            // the timer has stopped, quit updating the display.
            clearInterval(updater_id);

            blank = function(val) {
                if(Number(val) == 0) {
                    return '';
                } else {
                    return val;
                }
            }

            var mode = $('#purpose').val()
            var total = $('#total_time').text();
            var night = blank($('#night_time').text());
            var hood = blank($('#hood_time').text());
            var actual = blank($('#actual_time').text());
            var day_l = blank($('#day_landings').text());
            var night_l = blank($('#night_landings').text());
            var approaches = blank($('#approaches').text());

            $('input[name=total]').val(total);
            $('input[name=night]').val(night);
            $('input[name=act_inst]').val(actual);
            $('input[name=sim_inst]').val(hood);
            $('input[name=app]').val(approaches);
            $('input[name=night_l]').val(night_l);
            $('input[name=day_l]').val(day_l);

            if(mode == 'student') {
                $('input[name=dual_r]').val(total);
            }
            if(mode == 'fo') {
                $('input[name=sic]').val(total);
            }
            if(mode == 'captain') {
                $('input[name=pic]').val(total);
            }
            if(mode == 'instructor') {
                $('input[name=dual_g]').val(total);
                $('input[name=pic]').val(total);
            }
            if(mode == 'solo') {
                $('input[name=solo]').val(total);
                $('input[name=pic]').val(total);
            }
            if(mode == 'training') {
                $('input[name=dual_r]').val(total);
                $('input[name=pic]').val(total);
            }
        });

        $('#submit_button').click(function() {
            send_data();
        });

        $('select#plane').change(function() {
            var selected = $(this).val();
            for(var p in planes) {
                var plane = planes[p];
                if(plane['id'] == selected) {
                    set_currency_display(plane['currency'])
                }
            }
        });


        </script>
    </body>
</html>